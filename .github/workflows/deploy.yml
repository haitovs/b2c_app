name: Deploy B2C Frontend

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------
      # STEP 1: PREPARE & BUILD ON GITHUB
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Web Release
        run: |
          flutter build web --release \
            --dart-define=B2C_API_URL=https://b2c.oguzforum.com \
            --dart-define=TOURISM_API_URL=http://backend:8000

      # ---------------------------------------------------------
      # STEP 2: PREPARE SERVER (Self-Healing Sync)
      # ---------------------------------------------------------
      - name: Sync Config Files via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -Eeuo pipefail
            export GIT_SSH_COMMAND='ssh -i ~/.ssh/deploy_b2c_app -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new'
            
            APP_DIR="/home/main/apps/b2c_app"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            
            # --- FIX: HEAL BROKEN REPO ---
            # If .git folder is missing (because SCP wiped it), re-initialize it.
            if [ ! -d ".git" ]; then
              echo "==> Repo missing or broken. Re-initializing..."
              git init
              git remote add origin git@github.com:haitovs/b2c_app.git || git remote set-url origin git@github.com:haitovs/b2c_app.git
            fi
            
            echo "==> Fetching latest configs..."
            git fetch --all --prune
            git reset --hard origin/main

      # ---------------------------------------------------------
      # STEP 3: UPLOAD BUILT ASSETS (Targeted Upload)
      # ---------------------------------------------------------
      - name: Copy built files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "build/web/*,docker-compose.yml,Dockerfile,nginx.conf"
          target: "/home/main/apps/b2c_app/"
          rm: false

      # ---------------------------------------------------------
      # STEP 4: RESTART DOCKER
      # ---------------------------------------------------------
      - name: Restart Container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          # FIX: Increase timeout to 60 minutes (default is 10m) 
          command_timeout: 60m
          script: |
            set -Eeuo pipefail
            cd /home/main/apps/b2c_app
            
            if docker compose version >/dev/null 2>&1; then DC="docker compose"; else DC="docker-compose"; fi
            
            echo "==> Rebuilding..."
            $DC build --no-cache b2c-frontend
            $DC up -d b2c-frontend
            
            echo "==> Pruning..."
            docker image prune -f